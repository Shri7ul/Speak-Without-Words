<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Speak Without Words</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      @keyframes pop { 0% { transform: scale(0.98); opacity: 0.6; } 100% { transform: scale(1); opacity: 1; } }
      .pop { animation: pop 180ms ease-out; }
    </style>
  </head>

  <body class="bg-slate-50 text-slate-900">
    <!-- Banners -->
    <div id="unlockBanner" class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-2xl bg-emerald-600 text-white text-lg font-extrabold shadow-xl">
      ü§ù UNDERSTOOD (Secret Code)
    </div>

    <div id="handsUpBanner" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-2xl bg-red-600 text-white text-lg font-extrabold shadow-xl">
      üôå HANDS UP
    </div>

    <div id="teamBanner" class="hidden fixed top-32 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-2xl bg-emerald-700 text-white text-lg font-extrabold shadow-xl">
      üöÄ TEAM READY
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-6">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-5">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Speak Without Words</h1>
          <p class="text-slate-600">Gesture ‚Üí Intent ‚Üí Visual language (real-time)</p>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-600">Mode</span>
          <button id="modeBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm text-sm font-semibold hover:bg-slate-100 active:scale-[0.99]">
            Demo
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Video -->
        <div class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl shadow-sm p-3">
          <div class="relative rounded-2xl overflow-hidden border border-slate-200">
            <img src="/video_feed" alt="camera stream" class="w-full h-auto block" />

            <div class="absolute left-3 top-3">
              <div id="overlayBadge" class="px-4 py-2 rounded-full font-extrabold text-white shadow-md bg-slate-700">‚Ä¶</div>
              <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/90 border border-slate-200 text-xs font-semibold text-slate-700">
                Confidence: <span id="confTxt">0.00</span>
              </div>
            </div>

            <div id="helpFlash" class="hidden absolute inset-0 bg-red-200/40"></div>
            <div id="handsFlash" class="hidden absolute inset-0 bg-red-400/35"></div>
            <div id="teamFlash" class="hidden absolute inset-0 bg-emerald-300/25"></div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">‚õî Open palm ‚Üí STOP</span>
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">‚úã Fist ‚Üí WAIT</span>
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">üíô Peace ‚Üí CALM</span>
            <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200 text-red-700 font-semibold">üö® Open palm high ‚Üí HELP</span>
            <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200 text-red-700 font-semibold">üôå Both palms ‚Üí HANDS UP</span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-800 font-semibold">ü§ù Peace ‚Üí Fist ‚Üí Palm = UNDERSTOOD</span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-800 font-semibold">üöÄ Hands Up ‚Üí Peace = TEAM READY</span>
          </div>
        </div>

        <!-- Right column -->
        <div class="space-y-4">
          <!-- Status -->
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-extrabold">Status</h2>
              <span id="pillMood" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-700">
                neutral
              </span>
            </div>

            <div class="mt-3">
              <div class="text-sm text-slate-600">Current</div>
              <div id="bigLabel" class="mt-1 text-3xl font-extrabold tracking-tight">‚Ä¶</div>
              <div class="mt-2 text-sm text-slate-600">Gesture: <span id="gestureTxt" class="font-bold text-slate-900">NONE</span></div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between text-xs text-slate-600">
                <span>Confidence</span>
                <span id="confPct">0%</span>
              </div>
              <div class="mt-1 h-2 rounded-full bg-slate-100 overflow-hidden border border-slate-200">
                <div id="confBar" class="h-full w-0 bg-slate-700"></div>
              </div>
            </div>

            <div class="mt-5">
              <div class="flex items-center justify-between">
                <div class="text-sm font-bold">Recent (smoothed)</div>
                <button id="clearBtn" class="hidden px-2 py-1 rounded-lg border border-slate-200 text-xs font-semibold text-slate-700 hover:bg-slate-100">
                  Clear
                </button>
              </div>
              <div id="historyRow" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div id="devPanel" class="hidden mt-5 p-3 rounded-2xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-700 mb-2">Dev Debug</div>
              <pre id="raw" class="text-[11px] leading-snug text-slate-700 whitespace-pre-wrap break-all"></pre>
            </div>

            <div class="mt-6 text-xs text-slate-500">Tip: Hold gestures steady for better sequence accuracy.</div>
          </div>

          <!-- TRAINING MODE -->
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-extrabold">Training Mode</h2>
              <span id="trainState" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-700">
                OFF
              </span>
            </div>

            <div class="mt-3">
              <div class="text-sm text-slate-600">Do this:</div>
              <div id="trainTarget" class="mt-1 text-2xl font-extrabold">‚Äî</div>
              <div class="mt-2 text-sm text-slate-600">Score: <span id="trainScore" class="font-extrabold text-slate-900">0</span></div>
            </div>

            <div class="mt-4 flex gap-2">
              <button id="trainStart" class="flex-1 px-3 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 active:scale-[0.99]">
                Start
              </button>
              <button id="trainNext" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-bold hover:bg-slate-100 active:scale-[0.99]">
                Next
              </button>
              <button id="trainStop" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-bold hover:bg-slate-100 active:scale-[0.99]">
                Stop
              </button>
            </div>

            <div class="mt-3 text-xs text-slate-500">
              Tip: Hold each gesture ~1 sec for stable detection.
            </div>
          </div>

          <!-- COMMAND LOG -->
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-extrabold">Command Log</h2>
              <button id="logClear"
                class="px-2 py-1 rounded-lg border border-slate-200 text-xs font-bold text-slate-700 hover:bg-slate-100 active:scale-[0.99]">
                Clear
              </button>
            </div>

            <div id="logList" class="mt-3 space-y-2"></div>

            <div class="mt-3 text-xs text-slate-500">
              Shows latest detected commands (changes only).
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ================= VOICE SPEAK =================
      // Toggle this to false if you don't want voice
      const VOICE_ENABLED = true;

      function speak(text){
        if (!VOICE_ENABLED) return;

        try{
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = "en-US";
          utter.rate = 1.0;
          utter.pitch = 1.0;

          // stop previous speech
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utter);
        }catch(e){
          console.log("Speech error", e);
        }
      }

      // ================= OPTIONAL SOUND =================
      // Uncomment if you want sound instead of voice
      // Make sure file exists: static/sounds.mp3
      /*
      const helpSound = new Audio("/static/sounds.mp3");

      function playHelpSound(){
        try{
          helpSound.currentTime = 0;
          helpSound.play();
        }catch(e){}
      }
      */

      let mode = "demo";
      let lastGesture = "NONE";

      const modeBtn = document.getElementById("modeBtn");
      const devPanel = document.getElementById("devPanel");
      const clearBtn = document.getElementById("clearBtn");

      // training UI
      const trainState = document.getElementById("trainState");
      const trainTarget = document.getElementById("trainTarget");
      const trainScore = document.getElementById("trainScore");
      const trainStart = document.getElementById("trainStart");
      const trainNext = document.getElementById("trainNext");
      const trainStop = document.getElementById("trainStop");

      // log UI
      const logClear = document.getElementById("logClear");

      modeBtn.addEventListener("click", () => {
        mode = (mode === "demo") ? "dev" : "demo";
        modeBtn.textContent = (mode === "demo") ? "Demo" : "Dev";
        devPanel.classList.toggle("hidden", mode !== "dev");
        clearBtn.classList.toggle("hidden", mode !== "dev");
      });

      clearBtn.addEventListener("click", () => {
        document.getElementById("historyRow").innerHTML = "";
      });

      logClear.addEventListener("click", () => {
        document.getElementById("logList").innerHTML = "";
      });

      function moodStyles(mood){
        if (mood === "alert") return "bg-red-600";
        if (mood === "calm")  return "bg-blue-600";
        if (mood === "focus") return "bg-violet-600";
        if (mood === "good")  return "bg-emerald-600";
        return "bg-slate-700";
      }

      function labelIcon(label){
        if (label === "STOP") return "‚õî STOP";
        if (label === "WAIT") return "‚úã WAIT";
        if (label === "CALM") return "üíô CALM";
        if (label === "HELP") return "üö® HELP";
        if (label === "UNDERSTOOD") return "ü§ù UNDERSTOOD";
        if (label === "HANDS UP") return "üôå HANDS UP";
        if (label === "TEAM READY") return "üöÄ TEAM READY";
        return label || "‚Ä¶";
      }

      function renderHistory(hist){
        const row = document.getElementById("historyRow");
        row.innerHTML = "";
        (hist || []).slice(-7).forEach(g => {
          const textMap = {
            "OPEN_PALM": "STOP",
            "FIST": "WAIT",
            "PEACE": "CALM",
            "HELP": "HELP",
            "UNDERSTOOD": "UNDERSTOOD",
            "HANDS_UP": "HANDS UP",
            "TEAM_READY": "TEAM READY",
            "NONE": "‚Ä¶"
          };
          const t = textMap[g] || g;

          const chip = document.createElement("span");
          chip.className = "px-2.5 py-1 rounded-full text-xs font-bold border border-slate-200 bg-white text-slate-800";
          chip.textContent = t;
          row.appendChild(chip);
        });
      }

      function renderLog(events){
        const box = document.getElementById("logList");
        if (!box) return;

        box.innerHTML = "";
        const arr = (events || []).slice(0, 10);

        if (arr.length === 0){
          const empty = document.createElement("div");
          empty.className = "text-sm text-slate-500";
          empty.textContent = "No events yet‚Ä¶";
          box.appendChild(empty);
          return;
        }

        arr.forEach(ev => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-3 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50";

          const left = document.createElement("div");
          left.className = "text-sm font-bold text-slate-900";
          left.textContent = `${ev.t}  ${ev.g}`;

          const right = document.createElement("div");
          right.className = "text-xs font-bold text-slate-600";
          right.textContent = `conf ${Number(ev.c ?? 0).toFixed(2)}`;

          row.appendChild(left);
          row.appendChild(right);
          box.appendChild(row);
        });
      }

      function showBanner(el, ms=1500){
        el.classList.remove("hidden");
        el.classList.add("pop");
        setTimeout(() => el.classList.remove("pop"), 220);
        setTimeout(() => el.classList.add("hidden"), ms);
      }

      async function postJson(url){
        const res = await fetch(url, { method: "POST" });
        return res.json();
      }

      trainStart.addEventListener("click", async () => { await postJson("/training/start"); });
      trainNext.addEventListener("click", async () => { await postJson("/training/next"); });
      trainStop.addEventListener("click", async () => { await postJson("/training/stop"); });

      function updateTrainingUI(training){
        const on = !!training?.enabled;
        trainState.textContent = on ? "ON" : "OFF";
        trainState.className = "text-xs font-bold px-2 py-1 rounded-full border " +
          (on ? "bg-emerald-50 border-emerald-200 text-emerald-700" : "bg-slate-100 border-slate-200 text-slate-700");

        trainTarget.textContent = on ? (training.target || "‚Äî") : "‚Äî";
        trainScore.textContent = String(training.score ?? 0);
      }

      async function tick(){
        try{
          const res = await fetch("/predict?_=" + Date.now());
          const data = await res.json();

          const mood = data.mood || "neutral";
          const label = data.label || data.gesture || "‚Ä¶";
          const g = data.gesture || "NONE";
          const conf = Number(data.confidence ?? 0);

          const overlayBadge = document.getElementById("overlayBadge");
          overlayBadge.textContent = labelIcon(label);
          overlayBadge.className = "px-4 py-2 rounded-full font-extrabold text-white shadow-md " + moodStyles(mood);

          document.getElementById("confTxt").textContent = conf.toFixed(2);

          document.getElementById("bigLabel").textContent = labelIcon(label);
          document.getElementById("gestureTxt").textContent = g;

          const pill = document.getElementById("pillMood");
          pill.textContent = mood;
          pill.className = "text-xs font-bold px-2 py-1 rounded-full border " +
            (mood === "alert" ? "bg-red-50 border-red-200 text-red-700"
            : mood === "calm" ? "bg-blue-50 border-blue-200 text-blue-700"
            : mood === "focus"? "bg-violet-50 border-violet-200 text-violet-700"
            : mood === "good" ? "bg-emerald-50 border-emerald-200 text-emerald-700"
            : "bg-slate-100 border-slate-200 text-slate-700");

          const pct = Math.max(0, Math.min(1, conf));
          document.getElementById("confPct").textContent = Math.round(pct * 100) + "%";
          document.getElementById("confBar").style.width = Math.round(pct * 100) + "%";

          renderHistory(data.history);
          renderLog(data.events);

          if (mode === "dev") {
            document.getElementById("raw").textContent = JSON.stringify(data, null, 2);
          }

          updateTrainingUI(data.training);

          // ================= SPEAK ON CHANGE =================
          if (g !== lastGesture && g !== "NONE") {
            // Speak human-friendly label: STOP / HELP / TEAM READY etc.
            speak(label);

            // OPTIONAL sound for HELP only (instead of voice)
            /*
            if (g === "HELP") {
              playHelpSound();
            }
            */
          }

          const helpFlash = document.getElementById("helpFlash");
          if (g === "HELP" && lastGesture !== "HELP") {
            helpFlash.classList.remove("hidden");
            setTimeout(() => helpFlash.classList.add("hidden"), 250);
          }

          const handsFlash = document.getElementById("handsFlash");
          const handsBanner = document.getElementById("handsUpBanner");
          if (g === "HANDS_UP" && lastGesture !== "HANDS_UP") {
            handsFlash.classList.remove("hidden");
            setTimeout(() => handsFlash.classList.add("hidden"), 300);
            showBanner(handsBanner, 1400);
          }

          const teamFlash = document.getElementById("teamFlash");
          const teamBanner = document.getElementById("teamBanner");
          if (g === "TEAM_READY" && lastGesture !== "TEAM_READY") {
            teamFlash.classList.remove("hidden");
            setTimeout(() => teamFlash.classList.add("hidden"), 300);
            showBanner(teamBanner, 1500);
          }

          const unlockBanner = document.getElementById("unlockBanner");
          if (g === "UNDERSTOOD") {
            showBanner(unlockBanner, 2000);
          }

          lastGesture = g;

        } catch (e) {
          // ignore
        }
      }

      setInterval(tick, 200);
      tick();
    </script>
  </body>
</html>
