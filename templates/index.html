<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Speak Without Words</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-50 text-slate-900">
    <!-- Secret Handshake Banner -->
    <div id="unlockBanner"
         class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-50
                px-6 py-3 rounded-2xl bg-emerald-600 text-white
                text-lg font-extrabold shadow-xl">
      ü§ù UNDERSTOOD (Secret Code)
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-6">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-5">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Speak Without Words</h1>
          <p class="text-slate-600">Gesture ‚Üí Intent ‚Üí Visual language (real-time)</p>
        </div>

        <!-- Mode Toggle -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-600">Mode</span>
          <button id="modeBtn"
            class="px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm text-sm font-semibold hover:bg-slate-100 active:scale-[0.99]">
            Demo
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Video Card -->
        <div class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl shadow-sm p-3">
          <div class="relative rounded-2xl overflow-hidden border border-slate-200">
            <img src="/video_feed" alt="camera stream" class="w-full h-auto block" />

            <!-- Overlay badge -->
            <div class="absolute left-3 top-3">
              <div id="overlayBadge"
                   class="px-4 py-2 rounded-full font-extrabold text-white shadow-md bg-slate-700">
                ‚Ä¶
              </div>
              <div
                class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/90 border border-slate-200 text-xs font-semibold text-slate-700">
                Confidence: <span id="confTxt">0.00</span>
              </div>
            </div>

            <!-- HELP Flash layer -->
            <div id="helpFlash" class="hidden absolute inset-0 bg-red-200/40"></div>
          </div>

          <!-- Hint chips -->
          <div class="mt-3 flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">‚õî Open palm ‚Üí STOP</span>
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">‚úã Fist ‚Üí WAIT</span>
            <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">üíô Peace ‚Üí CALM</span>
            <span class="px-3 py-1 rounded-full bg-red-50 border border-red-200 text-red-700 font-semibold">üö® Open palm high ‚Üí HELP</span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-800 font-semibold">ü§ù Peace ‚Üí Fist ‚Üí Palm = UNDERSTOOD</span>
          </div>
        </div>

        <!-- Status Card -->
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-extrabold">Status</h2>
            <span id="pillMood" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-700">
              neutral
            </span>
          </div>

          <div class="mt-3">
            <div class="text-sm text-slate-600">Current</div>
            <div id="bigLabel" class="mt-1 text-3xl font-extrabold tracking-tight">‚Ä¶</div>
            <div class="mt-2 text-sm text-slate-600">Gesture: <span id="gestureTxt" class="font-bold text-slate-900">NONE</span></div>
          </div>

          <!-- Confidence bar -->
          <div class="mt-4">
            <div class="flex items-center justify-between text-xs text-slate-600">
              <span>Confidence</span>
              <span id="confPct">0%</span>
            </div>
            <div class="mt-1 h-2 rounded-full bg-slate-100 overflow-hidden border border-slate-200">
              <div id="confBar" class="h-full w-0 bg-slate-700"></div>
            </div>
          </div>

          <!-- History -->
          <div class="mt-5">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold">Recent (smoothed)</div>
              <button id="clearBtn"
                class="hidden px-2 py-1 rounded-lg border border-slate-200 text-xs font-semibold text-slate-700 hover:bg-slate-100">
                Clear
              </button>
            </div>
            <div id="historyRow" class="mt-2 flex flex-wrap gap-2"></div>
          </div>

          <!-- Dev panel -->
          <div id="devPanel" class="hidden mt-5 p-3 rounded-2xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-bold text-slate-700 mb-2">Dev Debug</div>
            <pre id="raw" class="text-[11px] leading-snug text-slate-700 whitespace-pre-wrap break-all"></pre>
          </div>

          <div class="mt-6 text-xs text-slate-500">
            Tip: Keep palm facing camera for best stability.
          </div>
        </div>
      </div>
    </div>

    <script>
      let mode = "demo";
      let lastGesture = "NONE";

      const modeBtn = document.getElementById("modeBtn");
      const devPanel = document.getElementById("devPanel");
      const clearBtn = document.getElementById("clearBtn");

      modeBtn.addEventListener("click", () => {
        mode = (mode === "demo") ? "dev" : "demo";
        modeBtn.textContent = (mode === "demo") ? "Demo" : "Dev";
        devPanel.classList.toggle("hidden", mode !== "dev");
        clearBtn.classList.toggle("hidden", mode !== "dev");
      });

      clearBtn.addEventListener("click", () => {
        document.getElementById("historyRow").innerHTML = "";
      });

      function moodStyles(mood){
        if (mood === "alert") return "bg-red-600";
        if (mood === "calm")  return "bg-blue-600";
        if (mood === "focus") return "bg-violet-600";
        if (mood === "good")  return "bg-emerald-600";
        return "bg-slate-700";
      }

      function labelIcon(label){
        if (label === "STOP") return "‚õî STOP";
        if (label === "WAIT") return "‚úã WAIT";
        if (label === "CALM") return "üíô CALM";
        if (label === "HELP") return "üö® HELP";
        if (label === "UNDERSTOOD") return "ü§ù UNDERSTOOD";
        return label || "‚Ä¶";
      }

      function renderHistory(hist){
        const row = document.getElementById("historyRow");
        row.innerHTML = "";
        (hist || []).slice(-7).forEach(g => {
          const textMap = {
            "OPEN_PALM": "STOP",
            "FIST": "WAIT",
            "PEACE": "CALM",
            "HELP": "HELP",
            "UNDERSTOOD": "UNDERSTOOD",
            "NONE": "‚Ä¶"
          };
          const t = textMap[g] || g;

          const chip = document.createElement("span");
          chip.className = "px-2.5 py-1 rounded-full text-xs font-bold border border-slate-200 bg-white text-slate-800";
          chip.textContent = t;
          row.appendChild(chip);
        });
      }

      async function tick(){
        try{
          const res = await fetch("/predict?_=" + Date.now());
          const data = await res.json();

          const mood = data.mood || "neutral";
          const label = data.label || data.gesture || "‚Ä¶";
          const g = data.gesture || "NONE";
          const conf = Number(data.confidence ?? 0);

          // Overlay badge
          const overlayBadge = document.getElementById("overlayBadge");
          overlayBadge.textContent = labelIcon(label);
          overlayBadge.className = "px-4 py-2 rounded-full font-extrabold text-white shadow-md " + moodStyles(mood);

          // Overlay conf
          document.getElementById("confTxt").textContent = conf.toFixed(2);

          // Right panel
          document.getElementById("bigLabel").textContent = labelIcon(label);
          document.getElementById("gestureTxt").textContent = g;

          const pill = document.getElementById("pillMood");
          pill.textContent = mood;
          pill.className = "text-xs font-bold px-2 py-1 rounded-full border " +
            (mood === "alert" ? "bg-red-50 border-red-200 text-red-700"
            : mood === "calm" ? "bg-blue-50 border-blue-200 text-blue-700"
            : mood === "focus"? "bg-violet-50 border-violet-200 text-violet-700"
            : mood === "good" ? "bg-emerald-50 border-emerald-200 text-emerald-700"
            : "bg-slate-100 border-slate-200 text-slate-700");

          // Confidence bar
          const pct = Math.max(0, Math.min(1, conf));
          document.getElementById("confPct").textContent = Math.round(pct * 100) + "%";
          document.getElementById("confBar").style.width = Math.round(pct * 100) + "%";

          // History
          renderHistory(data.history);

          // Dev raw
          if (mode === "dev") {
            document.getElementById("raw").textContent = JSON.stringify(data, null, 2);
          }

          // HELP flash
          const flash = document.getElementById("helpFlash");
          if (g === "HELP" && lastGesture !== "HELP") {
            flash.classList.remove("hidden");
            setTimeout(() => flash.classList.add("hidden"), 250);
          }

          // ü§ù UNDERSTOOD banner
          const banner = document.getElementById("unlockBanner");
          if (g === "UNDERSTOOD") {
            banner.classList.remove("hidden");
            setTimeout(() => banner.classList.add("hidden"), 2000);
          }

          lastGesture = g;

        } catch (e) {
          // ignore
        }
      }

      setInterval(tick, 200);
      tick();
    </script>
  </body>
</html>
